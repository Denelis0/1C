


Изоляция рабочих процессов 1С на Linux с использованием `swpuser.ini`. В примере предполагается, что папка твоего кластера — `/var/1c_cluster`, а логи Технологического журнала лежат в `/var/log/1c`.

---

### Шаг 1. Создаем изолированных пользователей
Создаем двух системных пользователей без права входа в терминал (shell), но сразу добавляем их в общую группу 1С (`grp1cv8`).

```bash
# Если группы grp1cv8 вдруг нет, создаем её (обычно она есть)
sudo groupadd grp1cv8

sudo useradd -r -g grp1cv8 -s /bin/false 1c_agent

# Создаем пользователя для Менеджера кластера (rmngr)
sudo useradd -r -g grp1cv8 -s /bin/false 1c_manager

# Создаем пользователя для Рабочих процессов (rphost)
sudo useradd -r -g grp1cv8 -s /bin/false 1c_worker
```
`-r` - Этот флаг говорит, что мы создаем системного пользователя.

### Шаг 2. Выдаем правильные права на платформу (Бинарники)
Процессы должны уметь запускать файлы платформы, но не должны иметь возможности их изменять.
Системные аккаунты не имеют срока действия пароля, и для них по умолчанию не создаются лишние папки, которые нужны «живому» человеку. Это подчеркивает, что аккаунт нужен только для работы сервиса (`ragent`).

`-s /bin/false` - указывает, какую командную оболочку (интерфейс ввода команд) получит пользователь при входе.`/bin/false` — это «пустышка». Если кто-то попытается залогиниться на сервер под именем 1c_agent (через SSH или физически), система сразу же его «выбросит». Если хакер узнает пароль этого пользователя, он не сможет открыть консоль и навредить серверу.
```bash
# Владелец - root, группа - 1С
sudo chown -R root:grp1cv8 /opt/1cv8

# Права 750 (root может всё, группа может читать/запускать, остальные идут лесом)
sudo chmod -R 750 /opt/1cv8
```
`-R` - команда применить действие не только к самой папке, но и ко всему её содержимому внутри, включая все вложенные папки и каждый файл в них, до самого «дна» дерева каталогов.

### Шаг 3. Настраиваем общие папки с магией SGID
Это самый важный шаг для Linux. Мы делаем так, чтобы новые файлы всегда наследовались группой `grp1cv8`.

**1. Папка данных кластера (сеансовые данные, кэш):**
```bash
# Владельцем делаем 1c_manager, так как он управляет кластером
sudo chown -R 1c_manager:grp1cv8 /var/1c_cluster

# Даем полные права владельцу и группе
sudo chmod -R 2750 /var/1c_cluster

# Включаем бит SGID (не нужна)
sudo chmod g+s /var/1c_cluster
```

**2. Папка логов (Технологический журнал):**
```bash
sudo chown -R 1c_manager:grp1cv8 /var/log/1c
sudo chmod -R 2770 /var/log/1c
```

### Шаг 4. Создаем файл `swpuser.ini`
Файл должен лежать в корне твоей папки кластера (там, где лежит `1CV8Clst.lst`).

1. Открываем редактор:
   ```bash
   sudo nano /var/1c_cluster/swpuser.ini
   ```
2. Вставляем настройки. *Напоминаю: пароли в Linux игнорируются, но строчки `password=` должны быть обязательно, иначе 1С выдаст ошибку формата файла.*
   ```ini
   user=1c_worker
   password=dummy_pass
   rmngr_user=1c_manager
   rmngr_pass=dummy_pass
   ```
3. Сохраняем (`Ctrl+O`, `Enter`) и выходим (`Ctrl+X`).
4. Назначаем права на сам этот файл:
   ```bash
   sudo chown 1c_manager:grp1cv8 /var/1c_cluster/swpuser.ini
   sudo chmod 600 /var/1c_cluster/swpuser.ini
   ```

### Шаг 5. Переводим главного Агента (`ragent`) на запуск от `root`
Чтобы Агент мог "превращаться" в других пользователей (через системный вызов `setuid`), ему нужны права суперпользователя.

1. Открываем файл-переопределение системной службы 1С (подставь свою версию платформы!):
   ```bash
   sudo systemctl edit srv1cv8-8.3.24.1500@default.service
   ```
2. В редакторе в блоке `[Service]` меняем пользователя и группу:
   ```ini[Service]
   # Агент запускается от рута
   User=root
   Group=root
   
   # Убедись, что путь к кластеру указан правильно
   Environment=SRV1CV8_DATA=/var/1c_cluster
   ```
   либо (более правильно) дадим обычному пользователю (например, штатному usr1cv8) ровно одну "суперсилу" — право менять пользователя (setuid), не делая его полноправным админом.
   
   ```ini[Service]
   [Service]
   # Запускаем НЕ от рута, а от стандартного пользователя 1С
   User=1c_agent
   Group=grp1cv8

   # Выдаем точечные права на смену пользователя (для swpuser.ini)
   AmbientCapabilities=CAP_SETUID CAP_SETGID
   CapabilityBoundingSet=CAP_SETUID CAP_SETGID

   # Путь к кластеру
   Environment=SRV1CV8_DATA=/var/1c_cluster
   ```
4. Сохраняем и закрываем. Важный нюанс прав: Так как Агент теперь работает от `1c_agent`, убедись, что этот пользователь состоит в группе grp1cv8, и у группы есть права на запись в `/var/1c_cluster`.

### Шаг 6. Запуск и проверка (Момент истины)

1. Перезагружаем конфигурацию systemd и рестартуем 1С:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl restart srv1cv8-8.3.24.1500@default.service
   ```

2. **Проверяем результат:**
   ```bash
   ps aux | grep 1cv8
   ```

**Что ты должен увидеть в консоли:**
Ты увидишь список запущенных процессов. Смотри на самый левый столбец (Имя пользователя):
*   `root` либо `1c_ragent` ..... `/opt/1cv8/.../ragent`
*   `1c_manager` ..... `/opt/1cv8/.../rmngr`
*   `1c_worker` ..... `/opt/1cv8/.../rphost`

### Шаг 7 (дополнительный). 
Когда пользователи формируют тяжелую оборотку, 1С не держит всё в оперативной памяти. Она создает сотни временных файликов, сортирует их, сшивает и только потом выдает результат. Также во временные папки распаковываются файлы из хранилища и обменов.

**Как это работает по умолчанию:**
В Linux есть общая системная папка `/tmp`. По умолчанию у неё стоят права `1777` (Sticky Bit) — это значит, что **любой** пользователь ОС (включая нашего изолированного `1c_worker`) может создавать там свои файлы и папки. 
Поэтому, если ничего не трогать, `rphost` будет писать в `/tmp`, и ошибок доступа не будет.

**НО ПОЧЕМУ ЭТО ПЛОХО (Как мыслят Senior-админы):**
Папка `/tmp` часто находится на том же диске, что и сама операционная система (корневой раздел `/`). Если бухгалтер запустит кривой отчет, `rphost` может за 10 минут создать временных файлов на 50 ГБ, забив `/tmp` на 100%. Из-за этого «умрет» весь Linux, так как ОС не сможет писать свои логи и системные файлы.

### Как сделать правильно (Enterprise-подход):

Мы выделим для 1С **свою собственную временную папку**, желательно на другом (быстром SSD/NVMe) диске, и укажем `rphost` использовать только её.

**Шаг 1. Создаем отдельную папку для TMP**
```bash
# Создаем директорию
sudo mkdir -p /var/1c_tmp

# Владельцем делаем 1c_worker (ведь именно rphost пишет туда больше всего)
sudo chown -R 1c_worker:grp1cv8 /var/1c_tmp

# Даем полные права группе и вешаем SGID (чтобы файлы принадлежали группе)
sudo chmod -R 770 /var/1c_tmp
sudo chmod g+s /var/1c_tmp
```

**Шаг 2. Указываем 1С новый путь**
Снова открываем настройки нашей службы 1С:
```bash
sudo systemctl edit srv1cv8-8.3.24.1500@default.service
```
Добавляем переменную окружения `TMPDIR` в блок `[Service]`:
```ini
[Service]
...
Environment=SRV1CV8_DATA=/var/1c_cluster
# Заставляем ВСЕ процессы 1С писать временные файлы сюда:
Environment=TMPDIR=/var/1c_tmp
```

**Шаг 3. Перезапуск**
```bash
sudo systemctl daemon-reload
sudo systemctl restart srv1cv8-8.3.24.1500@default.service
```
