
---

# Как перевести 1С с HTTP на HTTPS (Простыми словами)

## Часть 1. В чем проблема HTTP? (Аналогия с Почтой)
Представь, что интернет — это обычная почта.
Когда бухгалтер открывает 1С по адресу `http://...` и вводит свой пароль, компьютер пишет этот пароль на **открытой почтовой открытке** и отправляет на сервер.

Пока эта открытка летит по проводам, ее может прочитать кто угодно.

Если пароль от 1С перехватят — злоумышленник зайдет в базу и скачает всю бухгалтерию. 

**Решение:** Нам нужен **HTTPS**. В этом случае пароль кладется в **бронированный сейф**. Сейф едет по интернету, хакер видит сейф, но открыть его не может — ключ есть только у твоего сервера.

---

## Часть 2. Как работает этот "Сейф"? 

### 1. Сертификат (Паспорт сервера)
Это электронный документ, который решает две задачи:
*   Доказывает компьютеру бухгалтера, что твой сервер — настоящий, а не подделка хакера (появляется **зеленый замочек** в браузере).
*   Внутри сертификата лежит математическая формула для создания того самого "сейфа".
*   У сертификата есть **Секретный ключ (Private Key)** — это ключ от сейфа. *Его должен знать только сервер, и его нельзя никому показывать!*

### 2. Веб-сервер Apache (Охранник-Переводчик)
Самое важное правило, которое нужно запомнить: **Сама 1С ничего не знает про HTTPS и сертификаты!** Она сидит в глубоком тылу. Всю грязную работу делает Apache.
*   Apache встречает зашифрованный сейф из интернета.
*   Открывает его своим секретным ключом.
*   Достает оттуда обычный понятный текст и передает его базе 1С.
*   1С формирует ответ (например, отчет), отдает Апачу.
*   Apache запирает ответ в новый сейф и отправляет бухгалтеру.

### 3. Центр сертификации (Нотариус)
Кто выдает сертификаты? Специальные доверенные организации в интернете (например, *Let's Encrypt*). Браузеры доверяют только им. Если ты сделаешь сертификат сам себе на коленке (самоподписанный), браузер будет ругаться красным экраном: *"Я не знаю этого парня!"*.

---

## Часть 3. Как перевести базу на HTTPS 

Представим, что база уже опубликована на HTTP, и мы хотим сделать её безопасной.

---

### Шаг 1. Подготовка сервера и установка нужных программ
```bash
sudo apt update && apt upgrade -y
sudo apt install apache2 openssl -y
```
**Что это:** Мы обновляем систему и устанавливаем сам веб-сервер **Apache** и утилиту **OpenSSL**. 
*OpenSSL* — это программа-кузнец, которая будет ковать для нас криптографические ключи (те самые ключи от сейфа).

### Шаг 2. Включаем суперспособности Apache
```bash
systemctl enable apache2
sudo a2enmod ssl
systemctl restart apache2
sudo a2enmod rewrite
```
**Что это:** 
1. Добавляем Apache в автозагрузку (чтобы сам включался после перезагрузки сервера).
2. `a2enmod ssl` — заставляем Apache выучить язык шифрования (включаем модуль SSL).
3. `a2enmod rewrite` — даем Apache профессию "Швейцара" (модуль перенаправлений, чтобы потом перекидывать юзеров с HTTP на HTTPS).

### Шаг 3. Даем права на переопределение (AllowOverride). 

`sudo nano /etc/apache2/apache2.conf`

```apache
<Directory /var/www/1C>
    AllowOverride ALL
</Directory>
```
**Что это:** Это настройка внутри Апача, которая говорит: *"Разрешаю применять хитрые правила маршрутизации в этой папке"*. Для 1С это часто нужно, чтобы корректно работали веб-сервисы и красивые ссылки.

### Шаг 4. Куем ключи от сейфа (Магия OpenSSL)
```bash
sudo mkdir /etc/apache2/certs
cd /etc/apache2/certs
sudo openssl req -new -newkey rsa:4096 -x509 -sha256 -days 365 -nodes -out apache.crt -keyout apache.key
```
**Что это:** Мы создаем папку `certs` и прямо в ней генерируем наш сертификат. 
Разберем эту страшную команду:
*   `rsa:4096` — делаем ОЧЕНЬ надежный замок (ключ длиной 4096 бит, взломать нереально).
*   `-days 365` — срок годности паспорта (сертификата) — 1 год. Через год процедуру придется повторить.
*   `-out apache.crt` — создать файл-сертификат (паспорт для клиентов).
*   `-keyout apache.key` — создать секретный ключ (тот самый, который нельзя никому отдавать).

### Шаг 5. Настраиваем порт 443 (Безопасная зона)

`sudo nano /etc/apache2/sites-enabled/000-default.conf`

```apache
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/1C

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # ШВЕЙЦАР: Перекидываем всех на HTTPS
    RewriteEngine on
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R=301,L]
</VirtualHost>
```
**Что это:** Мы объясняем Апачу: *"Слушай порт 443 (HTTPS). Включи движок шифрования (`SSLEngine on`). А вот пути к твоим ключам, которые мы только что выковали"*. 
Именно благодаря этому блоку 1С начнет работать по безопасному каналу.

### Шаг 6. Ставим Швейцара (Редирект с 80 на 443)
```apache
RewriteEngine on
RewriteCond %{HTTPS} !=on
RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1[R=301,L]
```
**Что это:** Это гениальное правило, которое вписывается в настройки обычного 80-го порта (HTTP). Оно работает так:
1.  **RewriteEngine on** — Швейцар, проснись!
2.  **RewriteCond %{HTTPS} !=on** — *Условие:* Если человек пришел НЕ по безопасному HTTPS (т.е. по обычному HTTP)...
3.  **RewriteRule...** — *Действие:* Возьми его ссылку, прилепи к ней спереди `https://` и пни его туда с кодом `301` (Permanent Redirect - переехал навсегда).

### Шаг 7. Команда `sudo nano /etc/apache2/sites-available/default-ssl.conf`

```apache
<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/1C

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # СЕЙФ: Включаем шифрование и показываем ключи
        SSLEngine on
        SSLCertificateFile /etc/apache2/certs/apache.crt
        SSLCertificateKeyFile /etc/apache2/certs/apache.key
        
        # Если есть цепочка (bundle), раскомментируй строку ниже:
        # SSLCertificateChainFile /etc/apache2/certs/ca-bundle.crt
    </VirtualHost>
</IfModule>
```
### Шаг 8. Апач сейчас ничего не знает про второй файл. Его нужно «включить».

Выполняем команды по очереди: `sudo a2ensite default-ssl.conf`. Проверяем, не опечатались ли мы и делаем рестарт:
`sudo apache2ctl configtest` и `sudo systemctl restart apache2`.
---

### Важный нюанс для реальной жизни:
Поскольку этот сертификат ты сделал **сам** (`openssl`), а не купил у официального Удостоверяющего центра, браузеры твоих бухгалтеров при первом входе напишут: 
**"Подключение не защищено. Сертификат выдан неизвестным издателем".**

Это нормально! **Трафик всё равно будет зашифрован на 100%.** 
Пользователю нужно будет просто нажать кнопку *"Дополнительно -> Все равно перейти на сайт"*. 

В Тонком клиенте 1С тоже может выскочить предупреждение о безопасности. Там нужно будет нажать "Принимать сертификат этого сервера". 


