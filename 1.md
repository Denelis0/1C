#!/bin/bash

RAC="/opt/1C/v8.3/x86_64/rac"

# Получаем UUID кластера
CLUSTER=$($RAC cluster list | awk '/cluster/ {print $3}')

if [ -z "$CLUSTER" ]; then
  echo "Кластер не найден!"
  exit 1
fi

echo "Найден кластер: $CLUSTER"
echo

# Показываем список баз
echo "Список информационных баз:"
$RAC infobase --cluster=$CLUSTER list | awk '/infobase/ {print NR")", $0}'

echo
read -p "Введите UUID базы (из строки выше): " INFOBASE

if [ -z "$INFOBASE" ]; then
  echo "UUID базы не введён!"
  exit 1
fi

# Получаем список сессий выбранной базы
SESSIONS=$($RAC session --cluster=$CLUSTER list | awk -v base="$INFOBASE" '
/session/ {session=$3}
/infobase/ && $3==base {print session}
')

if [ -z "$SESSIONS" ]; then
  echo "В выбранной базе активных сессий нет."
  exit 0
fi

echo
echo "Будут завершены следующие сессии:"
echo "$SESSIONS"
echo

read -p "Продолжить? (y/n): " CONFIRM
if [ "$CONFIRM" != "y" ]; then
  echo "Отменено."
  exit 0
fi

# Завершаем сессии
for SESSION in $SESSIONS
do
  echo "Завершение сессии $SESSION"
  $RAC session --cluster=$CLUSTER terminate --session=$SESSION
done

echo
echo "Готово."
галочку.

---

### 1. Группа "Базы данных" (Запросы к СУБД)
Здесь 1С разделила события под каждую конкретную СУБД. Тебе нужно включать **только свою**.

*   **`dbpostgrs` (PostgreSQL): Твой главный инструмент.** Логирует SQL-запросы, которые уходят в твой Postgres. Включаем с отбором по `Duration` (длительности), чтобы искать тормоза.
*   **`dbmssql` / `dbmssqlconn`:** Для серверов на Microsoft SQL Server. (Тебе не нужно).
*   **`dboracle`:** Для Oracle Database. (Тебе не нужно).
*   **`db2`:** Для IBM DB2. (Тебе не нужно).
*   **`dbv8dbeng`:** Для файловых баз 1С. (Тебе не нужно, у тебя сервер).
*   **`dbcopies` (Механизм копий БД):** Логирует работу "Датаакселератора" или механизма копий баз данных (когда тяжелые отчеты перенаправляются на отдельную копию базы, чтобы не грузить продуктив). Если не используете копии баз — не нужно.

### 2. Группа "Аварии и Ошибки" (Твоя скорая помощь)
*   **`excp` (Exceptions): Обязательно.** Аварийное завершение работы, программные ошибки платформы, разрывы связи. Ловим падения 1С.
*   **`excpcntx` (Exception Context): Обязательно (идет в паре с excp).** Показывает "стек вызова" — какой именно кусок кода или действие пользователя привело к ошибке `excp`.

### 3. Группа "Жизнь кластера" (Инфраструктура)
*   **`admin` (Действия администратора): Полезно.** Логирует всё, что делают через Консоль администрирования кластера 1С (создание баз, удаление сеансов, смена паролей). Хороший аудит.
*   **`clstr` (Cluster):** События внутри менеджера кластера. Балансировка нагрузки, работа отказоустойчивости. Обычному админу туда смотреть не нужно, включают только если кластер "сходит с ума" и неправильно распределяет сеансы.
*   **`conn` (Connections):** Установка и разрыв TCP-соединений между процессами кластера (rphost, rmngr) и клиентами. Включать только при поиске сетевых проблем (когда клиенты жалуются на "Соединение разорвано").
*   **`attn` (Attention):** Информационный "шум" кластера. Практически никогда не используется прикладными админами.

### 4. Группа "Код и Вызовы"
*   **`call` (Входящий вызов):** Момент, когда сервер начал выполнять кусок кода, который запросил клиент. (Мы обсуждали его в паре со `scall`). Включать только для глубокого поиска тормозов.

### 5. Группа "Специфические механизмы"
*   **`addin` (Внешние компоненты):** Логирует работу подключенного оборудования или сторонних библиотек (сканеры штрихкодов, драйверы касс, криптопровайдеры). Включаем, если у кладовщиков отваливаются сканеры или не пробиваются чеки.
*   **`eds` (Электронная цифровая подпись):** Ооочень полезно для бухгалтерии и ЭДО! Если документы не подписываются (ошибка криптографии), это событие покажет, почему 1С не может достучаться до сертификата КриптоПро/VipNet.
*   **`confloadfromfiles`:** Логирует процесс загрузки конфигурации 1С из исходных файлов (XML). Нужно только разработчикам, которые работают с системами контроля версий (Git, 1C:EDT) и CI/CD.
*   **`dhist` (История данных):** События встроенного механизма версионирования объектов (когда 1С запоминает, кто и как менял документ). Включать не нужно.

---

### И самый главный пункт:
*   **`all` (ВСЕ СОБЫТИЯ):** Это макрос. Если поставить эту галочку, 1С начнет писать в лог **ВООБЩЕ ВСЁ**.
    > ☠️ **Никогда не ставь `all` на "боевом" сервере!** Если ты сделаешь это на продуктиве, твой Linux-сервер зависнет от перегрузки диска (I/O), а место на жестком диске закончится за пару минут. Эту галочку используют только на пустой локальной тестовой базе разработчика.


