#!/bin/bash

RAC="/opt/1C/v8.3/x86_64/rac"

# Получаем UUID кластера
CLUSTER=$($RAC cluster list | awk '/cluster/ {print $3}')

if [ -z "$CLUSTER" ]; then
  echo "Кластер не найден!"
  exit 1
fi

echo "Найден кластер: $CLUSTER"
echo

# Показываем список баз
echo "Список информационных баз:"
$RAC infobase --cluster=$CLUSTER list | awk '/infobase/ {print NR")", $0}'

echo
read -p "Введите UUID базы (из строки выше): " INFOBASE

if [ -z "$INFOBASE" ]; then
  echo "UUID базы не введён!"
  exit 1
fi

# Получаем список сессий выбранной базы
SESSIONS=$($RAC session --cluster=$CLUSTER list | awk -v base="$INFOBASE" '
/session/ {session=$3}
/infobase/ && $3==base {print session}
')

if [ -z "$SESSIONS" ]; then
  echo "В выбранной базе активных сессий нет."
  exit 0
fi

echo
echo "Будут завершены следующие сессии:"
echo "$SESSIONS"
echo

read -p "Продолжить? (y/n): " CONFIRM
if [ "$CONFIRM" != "y" ]; then
  echo "Отменено."
  exit 0
fi

# Завершаем сессии
for SESSION in $SESSIONS
do
  echo "Завершение сессии $SESSION"
  $RAC session --cluster=$CLUSTER terminate --session=$SESSION
done

echo
echo "Готово."
